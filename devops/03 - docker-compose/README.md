## Prerequsite

Docker 19.03 or greater

Docker-compose 1.26 or greater

## Legend

Docker compose with 3 applications (frontend + backend + DB).

### Instructions for running

1. Bootstrap the DB:

`docker-compose up -d db`

`docker-compose run --rm flaskapp /bin/bash -c "cd /opt/services/flaskapp/src && python -c 'import database; database.init_db()'"`

2. Boot up the cluster

`docker-compose up -d`

3. Browse to localhost:8080 to see the app in action.

***
## Questions

1. What is the difference between Docker Compose and dockerfile? Why do I need Docker Compose?
    - Dockerfile is used to describe a set of instructions for building an image of a container. On the other hand, Compose was created to simplify the launch of several containers and describe the interfaces of their interaction with the host and each other. 

2. How do I parameterize compose for different environments?
    - The best practice is to create multiple compose files like docker-compose.yaml with base configuration and docker-compose.prod.yaml with production-specific settings and use the -f flag to combine them.  
    Examle:
        docker-compose -f docker-compose.yaml -f docker-compose.prod.yaml up

3. What types of entities are used in docker-compose and for what purpose?
    - sevices - each entity describes an instance of a container or service [Swarm] and their launch parameters. 
    - networks - each entity describes a communication channel between services or a host. Network types:
        - bridge - Bridge networks are usually used when your applications run in standalone containers that need to communicate.
        - host - remove network isolation between the container and the Docker host, and use the hostâ€™s networking directly.
        - overlay - Overlay networks connect multiple Docker daemons together and enable swarm services to communicate with each other. (Used in docker swarm)
        - none - self-describing :)
    - volumes - mechanism for persisting data generated by and used by Docker containers. There are three options for declaring volume in compose:
        - `<container_filesystem_path>` - Traditional volume
        - `<volume_name>:<container_filesystem_path>` - Named volume
        - `<host_filesystem_path>:<container_filesystem_path>` - Bind mount
    - configs - [Swarm only] used in docker swarm semantic analog of volumes 
    - secrets - [Swarm only] secrets used to centrally manage secret data and securely transmit it to only those containers that need access to it.

4. `*` How to output application logs?
    -       docker logs <container>
    -       docker-compose logs <service>
     Swarm:
    -       docker service logs <service>

4. `*` How to copy\upload a file from host machine to the container?
-           docker cp <source> <container>:<destination>
    Alternatively, we can use bind mount.

5. `*` How to save file changes made inside the container?

    Depending on the task, we can use volumes of the appropriate type 


***
## Tasks

* Docker-compose has a bug - investigate it! What would you improve?
    ```yaml
    volumes:
      - ./conf.d:/etc/nginx/conf.d
    ```
    should be:
    ```yaml
    volumes:
      - ./conf.d:/etc/nginx/conf.d/
    ```

    Other issues I found:
    1. database.py:

        `'postgres://...' replaced for 'postgresql://...'`

    2. Dockerfile

       `MAINTAINER is deprecated in favor of LABEL.`

    3. conf.d/flaskapp.conf

        ```nginx
        proxy_set_header   Host                 $host;
        ```
        this header is duplicated and results in a redirect to `http://localhost,localhost:8080/success`

- [X] Docker-compose with an environment file. Create 2 different environment files for docker-compose

- [X] `*` Change the `docker-compose.yml` to run through dockerstack with code reuse (don't repeat yourself)
    1. Removed `driver: bridge` option in networks, because it is default for docker compose anyway, but removing it will allow to lauch stacks, since overlay driver is default for them
